<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Analytics | Adelante Maps</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Page Content -->
    <div class="container mx-auto px-4 py-6">
        <!-- Back Button -->
        <div class="mb-4">
            <a href="/maps" class="text-green-600 hover:text-green-700">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Maps
            </a>
        </div>

        <!-- Page Header -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Senior High School Analytics</h1>
            <p class="text-gray-600 text-sm">Visualizing student demographics and distribution</p>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Age Distribution Card -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="border-b border-gray-200 pb-3 mb-3">
                    <div class="flex items-center">
                        <i class="fas fa-birthday-cake text-blue-600 mr-2"></i>
                        <h2 class="text-lg font-medium text-gray-800">Age Distribution</h2>
                    </div>
                    <p class="text-gray-600 text-xs mt-1">Number of students by age group</p>
                </div>
                <div>
                    <div class="h-72" id="ageChartContainer">
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Strand Distribution Card -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="border-b border-gray-200 pb-3 mb-3">
                    <div class="flex items-center">
                        <i class="fas fa-book text-purple-600 mr-2"></i>
                        <h2 class="text-lg font-medium text-gray-800">Strand Distribution</h2>
                    </div>
                    <p class="text-gray-600 text-xs mt-1">Number of students by academic strand</p>
                </div>
                <div>
                    <div class="h-72" id="strandChartContainer">
                        <canvas id="strandChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Summary -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h3 class="text-lg font-medium text-gray-800 mb-3">Key Insights</h3>
            <div id="dataSummary" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="bg-gray-50 rounded p-3">
                    <div class="text-xs text-gray-500 mb-1">Total Students</div>
                    <div id="totalStudents" class="text-xl font-bold text-gray-800">--</div>
                </div>
                <div class="bg-gray-50 rounded p-3">
                    <div class="text-xs text-gray-500 mb-1">Most Common Age</div>
                    <div id="commonAge" class="text-xl font-bold text-gray-800">--</div>
                </div>
                <div class="bg-gray-50 rounded p-3">
                    <div class="text-xs text-gray-500 mb-1">Most Popular Strand</div>
                    <div id="popularStrand" class="text-xl font-bold text-gray-800">--</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart colors
        const chartColors = {
            age: {
                background: 'rgba(59, 130, 246, 0.2)',
                border: 'rgba(59, 130, 246, 1)'
            },
            strand: [
                { background: 'rgba(239, 68, 68, 0.2)', border: 'rgba(239, 68, 68, 1)' },
                { background: 'rgba(16, 185, 129, 0.2)', border: 'rgba(16, 185, 129, 1)' },
                { background: 'rgba(245, 158, 11, 0.2)', border: 'rgba(245, 158, 11, 1)' },
                { background: 'rgba(139, 92, 246, 0.2)', border: 'rgba(139, 92, 246, 1)' },
                { background: 'rgba(14, 165, 233, 0.2)', border: 'rgba(14, 165, 233, 1)' },
                { background: 'rgba(236, 72, 153, 0.2)', border: 'rgba(236, 72, 153, 1)' }
            ]
        };

        async function fetchData() {
            try {
                const response = await fetch('/api/senior-high-students/all');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                initializeCharts(data);
                updateSummary(data);
            } catch (error) {
                console.error('There has been a problem with your fetch operation:', error);
            }
        }

        function initializeCharts(data) {
            const ageData = {};
            const strandData = {};

            // Process data for charts
            data.forEach(item => {
                const age = item.age;
                const strand = item.strand;

                if (age) {
                    ageData[age] = (ageData[age] || 0) + 1;
                }
                if (strand) {
                    strandData[strand] = (strandData[strand] || 0) + 1;
                }
            });

            const ageLabels = Object.keys(ageData).sort((a, b) => a - b);
            const ageValues = ageLabels.map(age => ageData[age]);
            
            const strandLabels = Object.keys(strandData);
            const strandValues = Object.values(strandData);

            // Age Chart
            const ageCtx = document.getElementById('ageChart').getContext('2d');
            new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: ageLabels,
                    datasets: [{
                        label: 'Number of Students',
                        data: ageValues,
                        backgroundColor: chartColors.age.background,
                        borderColor: chartColors.age.border,
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label + ' years old';
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });

            // Strand Chart
            const strandCtx = document.getElementById('strandChart').getContext('2d');
            new Chart(strandCtx, {
                type: 'pie',
                data: {
                    labels: strandLabels,
                    datasets: [{
                        data: strandValues,
                        backgroundColor: chartColors.strand.map(color => color.background),
                        borderColor: chartColors.strand.map(color => color.border),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateSummary(data) {
            // Calculate total students
            const totalStudents = data.length;
            document.getElementById('totalStudents').textContent = totalStudents;
            
            // Calculate most common age
            const ageCount = {};
            data.forEach(student => {
                if (student.age) {
                    ageCount[student.age] = (ageCount[student.age] || 0) + 1;
                }
            });
            
            let mostCommonAge = null;
            let maxAgeCount = 0;
            
            for (const [age, count] of Object.entries(ageCount)) {
                if (count > maxAgeCount) {
                    mostCommonAge = age;
                    maxAgeCount = count;
                }
            }
            
            document.getElementById('commonAge').textContent = mostCommonAge ? `${mostCommonAge} years` : 'N/A';
            
            // Calculate most popular strand
            const strandCount = {};
            data.forEach(student => {
                if (student.strand) {
                    strandCount[student.strand] = (strandCount[student.strand] || 0) + 1;
                }
            });
            
            let mostPopularStrand = null;
            let maxStrandCount = 0;
            
            for (const [strand, count] of Object.entries(strandCount)) {
                if (count > maxStrandCount) {
                    mostPopularStrand = strand;
                    maxStrandCount = count;
                }
            }
            
            document.getElementById('popularStrand').textContent = mostPopularStrand || 'N/A';
        }

        // Initial data fetch
        fetchData();
    </script>
</body>
</html>