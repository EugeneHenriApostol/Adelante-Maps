<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Analytics | Adelante Maps</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- content -->
    <div class="container mx-auto px-4 py-6">
        <!-- back button -->
        <div class="mb-4">
            <a href="/maps" class="text-green-600 hover:text-green-700">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Maps
            </a>
        </div>

        <!-- header -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">College Analytics</h1>
            <p class="text-gray-600 text-sm">Visualizing student demographics and distribution</p>
        </div>

        <!-- charts grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- age distribution card -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="border-b border-gray-200 pb-3 mb-3">
                    <div class="flex items-center">
                        <i class="fas fa-birthday-cake text-blue-600 mr-2"></i>
                        <h2 class="text-lg font-medium text-gray-800">Age Distribution</h2>
                    </div>
                    <p class="text-gray-600 text-xs mt-1">Number of students by age group</p>
                </div>
                <div>
                    <div class="h-72 relative" id="ageChartContainer">
                        <canvas id="ageChart"></canvas>
                        <div id="ageChartLoader" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-700"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- course distribution card -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="border-b border-gray-200 pb-3 mb-3">
                    <div class="flex items-center">
                        <i class="fas fa-graduation-cap text-purple-600 mr-2"></i>
                        <h2 class="text-lg font-medium text-gray-800">Course Distribution</h2>
                    </div>
                    <p class="text-gray-600 text-xs mt-1">Number of students by college course</p>
                </div>
                <div>
                    <div class="h-72 relative" id="courseChartContainer">
                        <canvas id="courseChart"></canvas>
                        <div id="courseChartLoader" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-700"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- data summary -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h3 class="text-lg font-medium text-gray-800 mb-3">Key Insights</h3>
            <div id="dataSummary" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="bg-gray-50 rounded p-3">
                    <div class="text-xs text-gray-500 mb-1">Total Students</div>
                    <div id="totalStudents" class="text-xl font-bold text-gray-800">--</div>
                </div>
                <div class="bg-gray-50 rounded p-3">
                    <div class="text-xs text-gray-500 mb-1">Most Common Age</div>
                    <div id="commonAge" class="text-xl font-bold text-gray-800">--</div>
                </div>
                <div class="bg-gray-50 rounded p-3">
                    <div class="text-xs text-gray-500 mb-1">Most Popular Course</div>
                    <div id="popularCourse" class="text-xl font-bold text-gray-800">--</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // chart colors
        const chartColors = {
            age: {
                background: 'rgba(59, 130, 246, 0.2)',
                border: 'rgba(59, 130, 246, 1)'
            },
            course: [
                { background: 'rgba(239, 68, 68, 0.2)', border: 'rgba(239, 68, 68, 1)' },
                { background: 'rgba(16, 185, 129, 0.2)', border: 'rgba(16, 185, 129, 1)' },
                { background: 'rgba(245, 158, 11, 0.2)', border: 'rgba(245, 158, 11, 1)' },
                { background: 'rgba(139, 92, 246, 0.2)', border: 'rgba(139, 92, 246, 1)' },
                { background: 'rgba(14, 165, 233, 0.2)', border: 'rgba(14, 165, 233, 1)' },
                { background: 'rgba(236, 72, 153, 0.2)', border: 'rgba(236, 72, 153, 1)' },
                { background: 'rgba(75, 85, 99, 0.2)', border: 'rgba(75, 85, 99, 1)' },
                { background: 'rgba(109, 40, 217, 0.2)', border: 'rgba(109, 40, 217, 1)' }
            ]
        };

        async function fetchData() {
            try {
                // show loaders
                document.getElementById('ageChartLoader').style.display = 'flex';
                document.getElementById('courseChartLoader').style.display = 'flex';
                
                const response = await fetch('/api/college-students/all');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                // hide loaders
                document.getElementById('ageChartLoader').style.display = 'none';
                document.getElementById('courseChartLoader').style.display = 'none';
                
                initializeCharts(data);
                updateSummary(data);
            } catch (error) {
                console.error('There has been a problem with your fetch operation:', error);
                
                // Hide loaders
                document.getElementById('ageChartLoader').style.display = 'none';
                document.getElementById('courseChartLoader').style.display = 'none';
            }
        }

        function initializeCharts(data) {
            const ageData = {};
            const courseData = {};

            // Process data for charts
            data.forEach(item => {
                const age = item.age;
                const course = item.course;

                if (age) {
                    ageData[age] = (ageData[age] || 0) + 1;
                }
                if (course) {
                    courseData[course] = (courseData[course] || 0) + 1;
                }
            });

            const ageLabels = Object.keys(ageData).sort((a, b) => a - b);
            const ageValues = ageLabels.map(age => ageData[age]);
            
            const courseLabels = Object.keys(courseData);
            const courseValues = Object.values(courseData);

            // age chart
            const ageCtx = document.getElementById('ageChart').getContext('2d');
            new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: ageLabels,
                    datasets: [{
                        label: 'Number of Students',
                        data: ageValues,
                        backgroundColor: chartColors.age.background,
                        borderColor: chartColors.age.border,
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label + ' years old';
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });

            // course Chart
            const courseCtx = document.getElementById('courseChart').getContext('2d');
            new Chart(courseCtx, {
                type: 'pie',
                data: {
                    labels: courseLabels,
                    datasets: [{
                        data: courseValues,
                        backgroundColor: chartColors.course.map(color => color.background),
                        borderColor: chartColors.course.map(color => color.border),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateSummary(data) {
            // calculate total students
            const totalStudents = data.length;
            document.getElementById('totalStudents').textContent = totalStudents;
            
            // calculate most common age
            const ageCount = {};
            data.forEach(student => {
                if (student.age) {
                    ageCount[student.age] = (ageCount[student.age] || 0) + 1;
                }
            });
            
            let mostCommonAge = null;
            let maxAgeCount = 0;
            
            for (const [age, count] of Object.entries(ageCount)) {
                if (count > maxAgeCount) {
                    mostCommonAge = age;
                    maxAgeCount = count;
                }
            }
            
            document.getElementById('commonAge').textContent = mostCommonAge ? `${mostCommonAge} years` : 'N/A';
            
            // calculate most popular course
            const courseCount = {};
            data.forEach(student => {
                if (student.course) {
                    courseCount[student.course] = (courseCount[student.course] || 0) + 1;
                }
            });
            
            let mostPopularCourse = null;
            let maxCourseCount = 0;
            
            for (const [course, count] of Object.entries(courseCount)) {
                if (count > maxCourseCount) {
                    mostPopularCourse = course;
                    maxCourseCount = count;
                }
            }
            
            document.getElementById('popularCourse').textContent = mostPopularCourse || 'N/A';
        }

        // initial data fetch
        fetchData();
    </script>
</body>
</html>